
# AI Brainstorm Board アプリケーション仕様書

## 1. 概要
「AI Brainstorm Board」は、ユーザーが設定したテーマについて、複数のAI人格（エージェント）が議論を行うバーチャル会議室アプリケーションです。異なる視点を持つAIたちが、司会者の進行のもとでブレインストーミングを行い、議論の内容を可視化します。

## 2. コア機能と動作モード

### 2.1 動作モード
*   **マルチエージェントモード:** 各エージェントごとに独立したモデルが人格を担当し、発言します。
*   **オフラインモード:** APIを使用せず、事前定義されたモックデータで動作を確認するデモモードです。

### 2.2 セットアップ画面
*   **トピック入力:** 会議の議題を設定。
*   **チーム編成:**
    *   **クイックスタート:** トピックに基づき、最適な専門家チームをAIが自動生成。
    *   **カスタマイズ:** エージェントの追加・削除・編集（名前、役割、性格/指示、関心事、使用モデル）が可能。
    *   **プリセット選択:** 事前に定義されたチームテンプレートから選択可能。
    *   **設定の保存/読込:** JSONファイルへのエクスポート/インポート、ブラウザローカルストレージへの保存。
*   **参考資料:** テキストや画像をアップロード、または**直接テキストを入力（メモ追加）**して、議論のコンテキストとしてAIに渡すことが可能。
*   **言語設定:** 日本語、英語、フランス語、ドイツ語、イタリア語、中国語、韓国語、ポルトガル語に対応。
    *   **注釈:** 文言の追加・変更時は、サポートしている全言語のリソース(`constants.ts`)を必ず更新すること。
*   **モデル選択:** 
    *   **参加者用モデル (左側):** 会議に参加するエージェント（参加者）が使用するデフォルトモデル。
    *   **司会者用モデル (右側):** 司会進行を行うエージェントが使用するモデル。
*   **詳細設定 (画面下部・右寄せ):**
    *   **オフラインモード:** APIを使用せずモックで動作確認を行うモード。
    *   **デバッグモード:** 司会を含めた全参加者の発言の最後に、使用したモデル名を追記する。（モデルの自動ダウングレード対応しているため、それがわかるように）
*   **モデレーション設定:**
    *   **シックス・シンキング・ハッツ (Six Thinking Hats):** デフォルトOFF。ONの場合、司会者がフェーズごとに「思考の帽子（色）」を強制指定し、全員がその視点で発言するモードになる。
    *   **Fist-to-Five (合意形成):** デフォルトON。収束フェーズで司会者が提案をまとめ、全員で0〜5の投票を行う機能。
    *   **パーキングロット:** デフォルトON。脱線を保留する機能。
    *   **リフレーミング:** デフォルトON。批判を建設的な問いに変換する機能。

### 2.3 会議画面 (メイン機能)
*   **司会者 (Moderator):** 議論の進行、次期発言者の指名、議論の要約、投票の呼びかけを行います。
*   **参加者 (Agents):** 設定されたペルソナ（性格・関心事）に基づき発言します。
*   **ユーザー参加:** チャットボックスから議論に介入したり、追加資料を提示したりできます。
*   **ホワイトボード:** 議論の内容をリアルタイムで構造化（要約、カテゴリー分け）し、**JSONベースの付箋形式で可視化**します。各アイテムは「アイデア」「懸念」「決定事項」「情報」等に分類され、セクションごとに整理されます。
*   **一覧表示 (List View):** 会議の全テキストログを確認可能。スマートフォンのスクリーンサイズでは、これのみ表示。
*   **会議終了:** 終了時に確認ダイアログを表示。「議事録を作成して終了」を選択すると、議論全体を要約・構造化したMarkdown形式の議事録を生成し、ダウンロードできる。
*   **統計情報:** APIコール数、トークン使用量（入力/出力）をリアルタイム表示。

---

## 3. ロジックとAI挙動

### 3.1 使用モデルとフォールバック
Google GenAI SDK (`@google/genai`) を使用。以下の優先順位でフォールバック（自動ダウングレード）チェーンが実装されています。

1.  **gemini-3-pro-preview** (最高品質・デフォルト)
2.  **gemini-2.5-pro** (2.5 Pro)
3.  **gemini-2.5-flash** (高速)
4.  **gemini-2.5-flash-lite** (Flash Lite - 最終防衛ライン)

※ **モデル継続性:** エージェント単位で、一度ダウングレードが発生した場合、そのセッション中は当該モデルを継続利用（永続化）します。
※ **プロンプト管理:** プロンプトはAIによる動的生成ではなく、**`prompts.ts` に定義されたテンプレート**を使用し、変数を埋め込んでAPIへ送信します。

### 3.2 議論進行フロー (ステートマシン)
1.  **ゴール設定 (Goal Setting):** ユーザー入力トピックの具体性を判定し、曖昧なら明確化を求める。
2.  **オープニング (Intro):** 各エージェントが自己紹介と初期見解を述べる。
3.  **モデレーション (Moderating):**
    *   会話履歴とステータスを分析し、「次の発言者」と「進行発言」を決定。
    *   **Fist-to-Five判定:** 「収束フェーズ」かつ設定ONの場合、議論が熟したと判断すれば `voteProposal`（投票提案）を発行し、**投票フェーズ**へ移行する。
    *   **Six Hats制御:** 設定ONの場合、議論のフェーズに合わせて「次は赤の帽子（感情）で話しましょう」といったメタ指示を出す。
    *   **ホワイトボード更新:** モデレーターのターンと並行して、最新の議論内容を構造化データとして抽出し、ボードを更新する。
4.  **投票フェーズ (Voting - New):**
    *   司会者から提案があった場合のみ発生。
    *   全エージェントが並列（システム的には順次）で、提案に対するスコア（0:反対 〜 5:賛成）と短い理由を表明する。
    *   全員の投票終了後、再びモデレーションに戻り、結果（低スコア者のケア等）を処理する。
5.  **スピーキング (Speaking):** 指名されたエージェントが発言。
6.  **リアクション確認 (Hand Raising):** 発言後、他者が「反論」「補足」「まとめ」等の意図で挙手するか判定。
7.  **ループ:** ユーザー停止まで 3〜6 を繰り返す。

### 3.3 思考中の表示 (UI挙動)
*   **発言待機中:** アイコンは通常表示。
*   **思考中:** アイコン強調＋「Thinking...」。
*   **投票中:** 投票フェーズでは、各エージェントが順次投票スコア（✊, ☝️, ✌️...）を表示する。

---

## 4. データ定義 (主な型)

### Agent
*   ID, 名前, 役割, 色, システム指示書, **関心事(Interest)**, モデルID。

### ModeratorResponse
*   `nextSpeakerId`: 次の発言者ID。
*   `moderationText`: 司会者の発言内容。
*   `voteProposal` (Optional): Fist-to-Five投票を開始する場合の提案文。

### VoteResult
*   `agentId`: 投票したエージェントID。
*   `score`: 0〜5の整数。
*   `reason`: 投票理由。

### HandRaiseSignal
*   `agentId`, `type` (SYNTHESIS/SOLUTION/OBJECTION/etc), `reason`.

### WhiteboardData
*   `sections`: セクション（タイトル、付箋アイテム配列）のリスト。
*   `parkingLot`: 保留されたトピックのリスト。
*   `isGenerating`: 生成中フラグ。

## 5. ファイル構造
*   `App.tsx`: メインコンポーネント。
*   `hooks/useMeeting.ts`: 会議の進行ステート管理（Fist-to-Five投票ループ等の制御含む）。
*   `services/geminiService.ts`: Gemini APIとの通信ロジック。
*   `prompts.ts`: AIへの指示プロンプトテンプレート集（チーム生成、司会、発言、投票、ホワイトボード更新等）。
*   `components/`: UIコンポーネント群。
    *   `Whiteboard.tsx`: 構造化データを受け取り、付箋形式でレンダリングするコンポーネント。
*   `teams.ts`: プリセットチーム定義。
*   `types.ts`: 型定義。
*   `constants.ts`: 定数、翻訳データ。
