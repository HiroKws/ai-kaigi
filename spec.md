
# AI Brainstorm Board アプリケーション仕様書

## 1. 概要
「AI Brainstorm Board」は、ユーザーが設定したテーマについて、複数のAI人格（エージェント）が議論を行うバーチャル会議室アプリケーションです。異なる視点を持つAIたちが、司会者の進行のもとでブレインストーミングを行い、議論の内容を可視化します。

## 2. コア機能と動作モード

### 2.1 動作モード
*   **マルチエージェントモード ** 各エージェントごとに独立したモデルが人格を担当し、発言します。
*   **オフラインモード:** APIを使用せず、事前定義されたモックデータで動作を確認するデモモードです。

### 2.2 セットアップ画面
*   **トピック入力:** 会議の議題を設定。
*   **チーム編成:**
    *   **クイックスタート:** トピックに基づき、最適な専門家チームをAIが自動生成。
    *   **カスタマイズ:** エージェントの追加・削除・編集（名前、役割、性格/指示、関心事、使用モデル）が可能。
    *   **プリセット選択:** 事前に定義されたチームテンプレートから選択可能。
    *   **設定の保存/読込:** JSONファイルへのエクスポート/インポート、ブラウザローカルストレージへの保存。
*   **参考資料:** テキストや画像をアップロード、または**直接テキストを入力（メモ追加）**して、議論のコンテキストとしてAIに渡すことが可能。
*   **言語設定:** 日本語、英語など多言語に対応。
*   **モデル選択:** 会議全体またはエージェント個別のGeminiモデルを選択可能。
*   **デバッグモード** 司会を含めた全参加者の発言の最後に、使用したモデル名を追記する。（モデルの自動ダウングレード対応しているため、それがわかるように）

### 2.3 会議画面 (メイン機能)
*   **司会者 (Moderator):** 議論の進行、次期発言者の指名、議論の要約を行います。
*   **参加者 (Agents):** 設定されたペルソナ（性格・関心事）に基づき発言します。
*   **ユーザー参加:** チャットボックスから議論に介入したり、追加資料を提示したりできます。
*   **ホワイトボード:** 議論の内容をリアルタイムで構造化（要約、カテゴリー分け）し、視覚的なイメージ図（Visual Map）を生成します。ホワイトボードを書き込むのは、司会が担当。**現在ペンディング、表示域のみ確保しておく**
*   **一覧表示 (List View):** 会議の全テキストログを確認可能。スマートフォンのスクリーンサイズでは、これのみ表示。（旧：ログ表示）
*   **会議終了:** 終了時に確認ダイアログを表示。「議事録を作成して終了」を選択すると、議論全体を要約・構造化したMarkdown形式の議事録を生成し、ダウンロードできる。
*   **統計情報:** APIコール数、トークン使用量（入力/出力）をリアルタイム表示。全画面に表示し、初期処理から、司会／参加者の発言など、使用した全API呼び出しのうち、成功したもののみモデルごとに集計する。呼び出し回数と入力／出力トークン数を表示する。最後に前モデルの合計を表示する。

---

## 3. ロジックとAI挙動

### 3.1 使用モデルとフォールバック
Google GenAI SDK (`@google/genai`) を使用。以下の優先順位でフォールバック（自動ダウングレード）チェーンが実装されています。API制限（429エラーなど）が発生した場合、自動的に下位モデルへ切り替わります。

1.  **gemini-3-pro-preview** (最高品質・デフォルト)
2.  **gemini-2.0-pro-exp-02-05** (2.5 Pro)
3.  **gemini-2.5-flash** (高速)
4.  **gemini-2.0-flash-lite-preview-02-05** (Flash Lite - 最終防衛ライン)

※ 画像生成には `gemini-3-pro-image-preview` を使用。
※ リアクション確認（挙手判定）にはコスト削減のため `Flash Lite` を固定で使用。

### 3.2 議論進行ロジック
1.  **オープニング (Intro):**
    - ゴール設定フェーズを経て、各エージェントが自己紹介と初期の見解を述べる。
    - モデレーターは、最初に発言し、「テーマに関する全員の意見を順番に聴きたい」と伝える。

2.  **モデレーターのターン (Moderation):**
    - 会話履歴と挙手シグナルを分析し、次の発言者を決定する。
    - **ユーザー指示の優先 (User Command Priority):**
        - ユーザーの直近の発言が「意見」ではなく「指示（例：多数決を取って、～さんに聞いて、まとめて）」である場合、通常の指名ロジックを無視してその指示を最優先で実行する。
    - **選択ロジック (Convergence Priority):**
        1.  **ユーザーへの問いかけ:** 議論の承認や判断が必要な場合、司会者はユーザーを指名 (`nextSpeakerId: "user"`) し、質問を投げかける。この場合、システムはユーザー入力待ち状態となり、自動進行を一時停止する。
        2.  **収束・解決 (Highest):** `SYNTHESIS`（まとめ）や `SOLUTION`（解決策）の挙手があれば最優先で指名し、議論をゴールへ向かわせる。
        3.  **公平性 (Medium):** 上記がない場合、沈黙期間が長いエージェントを指名する（Silence Priority）。
        4.  **議論 (Low):** `OBJECTION`（反論）や `COMMENT`（コメント）の挙手。
    - **挙手リセット (Freshness):** 発言者が決定された時点で、**滞留している全ての挙手キューを消去**する。これにより、文脈の古い挙手が採用されるのを防ぐ。
    - **強制介入:** 議論がループ（A vs Bの膠着）した場合、モデレーターが自ら要約を行ったり、第三者を強制指名して場をリセットする。

3.  **エージェントのターン (Speaking):** 指名されたエージェントが発言。

4.  **リアクション確認 (Hand Raising):**
    - 発言完了後、他のエージェントが「関心事 (Interest)」に基づいて発言したいか判定する。
    - 判定AIは、単に手を挙げるだけでなく、**意図 (Sentiment/Type)** を付与する。
        - **Type:** `SYNTHESIS` (統合), `SOLUTION` (解決), `OBJECTION` (反論), `SUPPORT` (補足), `COMMENT` (感想)。
    - 議論を前進させる建設的な意図（Synthesis/Solution）が高く評価される。

5.  **ループ:** ユーザーが停止するまで2〜4を繰り返す。ユーザーが発言した場合、一時停止していたループは自動的に再開される。

### 3.3 思考中の表示 (UI挙動)
*   **発言待機中:** アイコンは通常表示。
*   **ユーザー入力待ち:** 司会者から指名された場合など、ユーザーの入力が必要な時は、ユーザーアイコンの周囲でスピナーが回転し続け、入力を視覚的に促す。
*   **思考中 (API通信中):**
    *   アイコンが回転アニメーション（線で囲む）で強調表示される。
    *   吹き出しには**前回の発言を残さず**、薄い色で「考え中… (Thinking...)」と表示する（誤認防止のため）。
*   **発言中:** 生成されたテキストが吹き出しに表示される。

---

## 4. プリセットチーム構成
以下のカテゴリー別チームテンプレートが実装されています。

### 4.1 Business & Tech
*   **AI Giants:** Elon Musk, Tim Cook, Geoffrey Hinton, Satya Nadella, Jensen Huang

### 4.2 Media & Opinion Leaders (日本のネット論客)
*   **落合陽一:** ビジョナリー（計算機自然、波動）
*   **堀江貴文:** プラグマティスト（合理性、既得権益破壊）
*   **ひろゆき:** デビルズ・アドボケイト（論破、コスパ）
*   **若新雄純:** ハーモナイザー/トリックスター（はみ出し者の肯定、脱構築）
*   **中田敦彦:** ストラテジスト（構造化、解説）

### 4.3 US Legendary Hosts (米歴代有名司会者)
*   **Oprah Winfrey:** ビジョナリー（魂の解放）
*   **Johnny Carson:** プラグマティスト（エンタメ、中立）
*   **Jon Stewart:** デビルズ・アドボケイト（風刺、権力批判）
*   **Ellen DeGeneres:** ハーモナイザー（親切、ダンス）
*   **Ed Sullivan:** ストラテジスト（時代を読む、キュレーション）

### 4.4 US Modern TV Hosts (米現代TVホスト)
*   **John Oliver:** ビジョナリー（調査報道）
*   **Jimmy Kimmel:** プラグマティスト（安定性）
*   **Bill Maher:** デビルズ・アドボケイト（反ポリコレ、本音）
*   **Kelly Clarkson:** ハーモナイザー（共感、歌）
*   **Andy Cohen:** ストラテジスト（炎上、バイラル）

### 4.5 Politics & Leaders
*   **Global Leaders:** MBS, Olaf Scholz, Vladimir Putin, Narendra Modi, Xi Jinping

### 4.6 History & Philosophy (Samurai / 武士)
*   **織田信長:** ビジョナリー（天下布武、破壊）
*   **徳川家康:** プラグマティスト（天下泰平、忍耐）
*   **明智光秀:** デビルズ・アドボケイト（大義、伝統）
*   **豊臣秀吉:** ハーモナイザー（人心掌握、成功）
*   **宮本武蔵:** ストラテジスト（兵法の理、孤高）

### 4.7 History & Philosophy (Great Minds)
*   **Great Minds:** Da Vinci, Augustus, Socrates, Lincoln, Sun Tzu

### 4.8 Anime & Fiction (Demon Slayer / 鬼滅)
*   **産屋敷耀哉:** ビジョナリー（打倒無惨、慈愛）
*   **冨岡義勇:** プラグマティスト（任務遂行、冷静）
*   **不死川実弥:** デビルズ・アドボケイト（鬼への憎悪、規律）
*   **胡蝶しのぶ:** ハーモナイザー（毒舌、調整）
*   **宇髄天元:** ストラテジスト（派手、現場指揮）

---

## 5. UIデザイン要件
*   **レスポンシブ対応:** モバイルとデスクトップでレイアウトを最適化。
*   **ダークモード:** OS設定またはユーザー操作により切り替え。
*   **視覚効果:**
    *   背景のアビエンスエフェクト。
    *   発言中のエージェントの拡大・強調。
    *   挙手時のアイコン表示。
    *   モデルダウングレード時の警告アイコン表示。
    *   **ユーザー待機時のスピナー表示。**

## 6. データ定義 (主な型)
*   **Agent:** ID, 名前, 役割, 色, システム指示書, **関心事(Interest)**, モデルID。
*   **WhiteboardData:** 要約, セクション(箇条書き), 生成画像URL。
*   **TeamTemplate:** プリセット用のチーム構成定義。
*   **HandRaiseSignal:** AgentID, Type (SYNTHESIS/SOLUTION/OBJECTION/etc), Reason。
